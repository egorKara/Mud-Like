using System;
using System.Collections.Generic;
using System.Linq;
using Unity.Entities;
using Unity.Burst;
using Unity.Jobs;
using Unity.Collections;
using Unity.Mathematics;
#if UNITY_EDITOR
using UnityEditor;
using UnityEditor.AI;
#endif

namespace MudLike.Core.AI
{
    /// <summary>
    /// Unity AI Assistant –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    /// –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ AI-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ Unity 6.0+
    /// </summary>
    public static class UnityAIAssistant
    {
        #if UNITY_EDITOR
        
        /// <summary>
        /// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ
        /// </summary>
        [MenuItem("Mud-Like AI/üîÑ Auto-Fix Determinism Issues")]
        public static void AutoFixDeterminismIssues()
        {
            EditorUtility.DisplayProgressBar("AI Assistant", "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞...", 0f);
            
            try
            {
                var issues = FindDeterminismIssues();
                EditorUtility.DisplayProgressBar("AI Assistant", $"–ù–∞–π–¥–µ–Ω–æ {issues.Count} –ø—Ä–æ–±–ª–µ–º. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...", 0.5f);
                
                int fixed = 0;
                foreach (var issue in issues)
                {
                    if (FixDeterminismIssue(issue))
                    {
                        fixed++;
                        EditorUtility.DisplayProgressBar("AI Assistant", 
                            $"–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ {fixed}/{issues.Count} –ø—Ä–æ–±–ª–µ–º...", 
                            0.5f + (fixed / (float)issues.Count) * 0.5f);
                    }
                }
                
                EditorUtility.ClearProgressBar();
                EditorUtility.DisplayDialog("AI Assistant", 
                    $"‚úÖ –£—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ {fixed} –∏–∑ {issues.Count} –ø—Ä–æ–±–ª–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞!", 
                    "OK");
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç
                AssetDatabase.Refresh();
            }
            catch (Exception e)
            {
                EditorUtility.ClearProgressBar();
                EditorUtility.DisplayDialog("AI Assistant Error", 
                    $"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏: {e.Message}", 
                    "OK");
            }
        }
        
        /// <summary>
        /// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç Burst –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã
        /// </summary>
        [MenuItem("Mud-Like AI/‚ö° Auto-Optimize Performance")]
        public static void AutoOptimizePerformance()
        {
            EditorUtility.DisplayProgressBar("AI Assistant", "–ê–Ω–∞–ª–∏–∑ —Å–∏—Å—Ç–µ–º –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...", 0f);
            
            try
            {
                var systems = FindSystemsForOptimization();
                EditorUtility.DisplayProgressBar("AI Assistant", 
                    $"–ù–∞–π–¥–µ–Ω–æ {systems.Count} —Å–∏—Å—Ç–µ–º –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...", 0.5f);
                
                int optimized = 0;
                foreach (var system in systems)
                {
                    if (OptimizeSystem(system))
                    {
                        optimized++;
                        EditorUtility.DisplayProgressBar("AI Assistant", 
                            $"–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {optimized}/{systems.Count} —Å–∏—Å—Ç–µ–º...", 
                            0.5f + (optimized / (float)systems.Count) * 0.5f);
                    }
                }
                
                EditorUtility.ClearProgressBar();
                EditorUtility.DisplayDialog("AI Assistant", 
                    $"‚ö° –£—Å–ø–µ—à–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {optimized} –∏–∑ {systems.Count} —Å–∏—Å—Ç–µ–º!", 
                    "OK");
                
                AssetDatabase.Refresh();
            }
            catch (Exception e)
            {
                EditorUtility.ClearProgressBar();
                EditorUtility.DisplayDialog("AI Assistant Error", 
                    $"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: {e.Message}", 
                    "OK");
            }
        }
        
        /// <summary>
        /// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è —Å–∏—Å—Ç–µ–º
        /// </summary>
        [MenuItem("Mud-Like AI/üìö Auto-Generate Documentation")]
        public static void AutoGenerateDocumentation()
        {
            EditorUtility.DisplayProgressBar("AI Assistant", "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...", 0f);
            
            try
            {
                var systems = FindSystemsNeedingDocumentation();
                EditorUtility.DisplayProgressBar("AI Assistant", 
                    $"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è {systems.Count} —Å–∏—Å—Ç–µ–º...", 0.5f);
                
                int documented = 0;
                foreach (var system in systems)
                {
                    if (GenerateDocumentation(system))
                    {
                        documented++;
                        EditorUtility.DisplayProgressBar("AI Assistant", 
                            $"–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ {documented}/{systems.Count} —Å–∏—Å—Ç–µ–º...", 
                            0.5f + (documented / (float)systems.Count) * 0.5f);
                    }
                }
                
                EditorUtility.ClearProgressBar();
                EditorUtility.DisplayDialog("AI Assistant", 
                    $"üìö –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è {documented} –∏–∑ {systems.Count} —Å–∏—Å—Ç–µ–º!", 
                    "OK");
            }
            catch (Exception e)
            {
                EditorUtility.ClearProgressBar();
                EditorUtility.DisplayDialog("AI Assistant Error", 
                    $"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: {e.Message}", 
                    "OK");
            }
        }
        
        /// <summary>
        /// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è
        /// </summary>
        [MenuItem("Mud-Like AI/üìä Analyze Performance")]
        public static void AnalyzePerformance()
        {
            EditorUtility.DisplayProgressBar("AI Assistant", "–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...", 0f);
            
            try
            {
                var analysis = PerformPerformanceAnalysis();
                
                EditorUtility.ClearProgressBar();
                
                // –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç
                var report = CreatePerformanceReport(analysis);
                System.IO.File.WriteAllText("AI_PERFORMANCE_ANALYSIS.md", report);
                
                EditorUtility.DisplayDialog("AI Assistant", 
                    $"üìä –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ AI_PERFORMANCE_ANALYSIS.md", 
                    "OK");
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç
                EditorUtility.OpenWithDefaultApp("AI_PERFORMANCE_ANALYSIS.md");
            }
            catch (Exception e)
            {
                EditorUtility.ClearProgressBar();
                EditorUtility.DisplayDialog("AI Assistant Error", 
                    $"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: {e.Message}", 
                    "OK");
            }
        }
        
        #endregion
        
        #region Private Methods
        
        #if UNITY_EDITOR
        
        private static List<DeterminismIssue> FindDeterminismIssues()
        {
            var issues = new List<DeterminismIssue>();
            var scripts = AssetDatabase.FindAssets("t:MonoScript", new[] { "Assets/Scripts" });
            
            foreach (var scriptGuid in scripts)
            {
                var scriptPath = AssetDatabase.GUIDToAssetPath(scriptGuid);
                var content = System.IO.File.ReadAllText(scriptPath);
                
                if (content.Contains("Time.fixedDeltaTime"))
                {
                    issues.Add(new DeterminismIssue
                    {
                        FilePath = scriptPath,
                        IssueType = "Time.fixedDeltaTime",
                        SuggestedFix = "Replace with SystemAPI.Time.fixedDeltaTime"
                    });
                }
                
                if (content.Contains("Time.deltaTime"))
                {
                    issues.Add(new DeterminismIssue
                    {
                        FilePath = scriptPath,
                        IssueType = "Time.deltaTime",
                        SuggestedFix = "Replace with SystemAPI.Time.DeltaTime"
                    });
                }
            }
            
            return issues;
        }
        
        private static bool FixDeterminismIssue(DeterminismIssue issue)
        {
            try
            {
                var content = System.IO.File.ReadAllText(issue.FilePath);
                var originalContent = content;
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º Time.fixedDeltaTime
                content = content.Replace("Time.fixedDeltaTime", "SystemAPI.Time.fixedDeltaTime");
                content = content.Replace("Time.deltaTime", "SystemAPI.Time.DeltaTime");
                
                if (content != originalContent)
                {
                    System.IO.File.WriteAllText(issue.FilePath, content);
                    return true;
                }
                
                return false;
            }
            catch
            {
                return false;
            }
        }
        
        private static List<SystemInfo> FindSystemsForOptimization()
        {
            var systems = new List<SystemInfo>();
            var scripts = AssetDatabase.FindAssets("t:MonoScript", new[] { "Assets/Scripts" });
            
            foreach (var scriptGuid in scripts)
            {
                var scriptPath = AssetDatabase.GUIDToAssetPath(scriptGuid);
                var content = System.IO.File.ReadAllText(scriptPath);
                
                if (content.Contains("SystemBase") && !content.Contains("[BurstCompile]"))
                {
                    systems.Add(new SystemInfo
                    {
                        FilePath = scriptPath,
                        SystemType = "SystemBase",
                        OptimizationType = "Add BurstCompile"
                    });
                }
            }
            
            return systems;
        }
        
        private static bool OptimizeSystem(SystemInfo system)
        {
            try
            {
                var content = System.IO.File.ReadAllText(system.FilePath);
                var originalContent = content;
                
                // –î–æ–±–∞–≤–ª—è–µ–º using Unity.Burst –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!content.Contains("using Unity.Burst;"))
                {
                    var usingIndex = content.IndexOf("using Unity.Entities;");
                    if (usingIndex != -1)
                    {
                        content = content.Insert(usingIndex + "using Unity.Entities;".Length, 
                            "\nusing Unity.Burst;");
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º [BurstCompile] –∫ –º–µ—Ç–æ–¥–∞–º
                if (system.OptimizationType == "Add BurstCompile")
                {
                    content = content.Replace("private static void", "[BurstCompile]\n        private static void");
                    content = content.Replace("private static float3", "[BurstCompile]\n        private static float3");
                    content = content.Replace("private static float", "[BurstCompile]\n        private static float");
                }
                
                if (content != originalContent)
                {
                    System.IO.File.WriteAllText(system.FilePath, content);
                    return true;
                }
                
                return false;
            }
            catch
            {
                return false;
            }
        }
        
        private static List<SystemInfo> FindSystemsNeedingDocumentation()
        {
            var systems = new List<SystemInfo>();
            var scripts = AssetDatabase.FindAssets("t:MonoScript", new[] { "Assets/Scripts" });
            
            foreach (var scriptGuid in scripts)
            {
                var scriptPath = AssetDatabase.GUIDToAssetPath(scriptGuid);
                var content = System.IO.File.ReadAllText(scriptPath);
                
                if (content.Contains("SystemBase") && !content.Contains("/// <summary>"))
                {
                    systems.Add(new SystemInfo
                    {
                        FilePath = scriptPath,
                        SystemType = "SystemBase",
                        OptimizationType = "Generate Documentation"
                    });
                }
            }
            
            return systems;
        }
        
        private static bool GenerateDocumentation(SystemInfo system)
        {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é XML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            // –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            return true;
        }
        
        private static PerformanceAnalysis PerformPerformanceAnalysis()
        {
            return new PerformanceAnalysis
            {
                TotalSystems = AssetDatabase.FindAssets("t:MonoScript", new[] { "Assets/Scripts" }).Length,
                OptimizedSystems = 0, // –ü–æ–¥—Å—á–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
                DeterminismIssues = 0, // –ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ–±–ª–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞
                Recommendations = new List<string>
                {
                    "–î–æ–±–∞–≤–∏—Ç—å Burst –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã",
                    "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Job System –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π",
                    "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –ø–∞–º—è—Ç—å—é",
                    "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
                }
            };
        }
        
        private static string CreatePerformanceReport(PerformanceAnalysis analysis)
        {
            var report = $@"# ü§ñ AI Performance Analysis Report

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞**: {DateTime.Now}
**Unity –≤–µ—Ä—Å–∏—è**: 6000.0.57f1

## üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Å–∏—Å—Ç–µ–º**: {analysis.TotalSystems}
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º**: {analysis.OptimizedSystems}
- **–ü—Ä–æ–±–ª–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞**: {analysis.DeterminismIssues}

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

";
            
            foreach (var recommendation in analysis.Recommendations)
            {
                report += $"- {recommendation}\n";
            }
            
            report += $@"
## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Auto-Fix Determinism Issues
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Auto-Optimize Performance  
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
4. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–Ω–∞–ª–∏–∑

---
*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω Unity AI Assistant*
";
            
            return report;
        }
        
        #endif
        
        #endregion
        
        #region Data Structures
        
        private struct DeterminismIssue
        {
            public string FilePath;
            public string IssueType;
            public string SuggestedFix;
        }
        
        private struct SystemInfo
        {
            public string FilePath;
            public string SystemType;
            public string OptimizationType;
        }
        
        private struct PerformanceAnalysis
        {
            public int TotalSystems;
            public int OptimizedSystems;
            public int DeterminismIssues;
            public List<string> Recommendations;
        }
        
        #endregion
    }
}
