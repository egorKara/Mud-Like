# Автоматизация тестирования и CI/CD

## Обзор

Данный документ описывает настройку автоматизации тестирования, CI/CD и мониторинга качества кода для проекта Mud-Like.

## GitHub Actions Workflows

### 1. Unit Tests (`unit-tests.yml`)

**Триггеры:**
- Push в ветки `main`, `develop`
- Pull Request в ветки `main`, `develop`
- Ежедневно в 2:00 UTC

**Функции:**
- Запуск Unit тестов
- Генерация отчетов о покрытии кода
- Загрузка результатов в Codecov
- Комментирование результатов в PR

**Настройка:**
```yaml
env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
  UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
```

### 2. Integration Tests (`integration-tests.yml`)

**Триггеры:**
- Push в ветки `main`, `develop`
- Pull Request в ветки `main`, `develop`
- Ежедневно в 3:00 UTC

**Функции:**
- Запуск интеграционных тестов
- Запуск тестов производительности
- Генерация отчетов о производительности

### 3. Build and Test (`build-and-test.yml`)

**Триггеры:**
- Push в ветки `main`, `develop`
- Pull Request в ветки `main`, `develop`
- Release

**Функции:**
- Сборка проекта для Linux
- Запуск тестов на собранной версии
- Quality Gate проверки
- Генерация сводки качества

### 4. SonarQube Analysis (`sonarqube.yml`)

**Триггеры:**
- Push в ветки `main`, `develop`
- Pull Request в ветки `main`, `develop`
- Ежедневно в 4:00 UTC

**Функции:**
- Анализ качества кода
- Проверка безопасности
- Анализ дублирования кода
- Quality Gate проверки

## Настройка Secrets

### Unity License Secrets

1. **UNITY_LICENSE** - Unity лицензия (Base64)
2. **UNITY_EMAIL** - Email для Unity ID
3. **UNITY_PASSWORD** - Пароль для Unity ID
4. **UNITY_SERIAL** - Серийный номер Unity

### SonarQube Secrets

1. **SONAR_TOKEN** - Токен SonarQube

### GitHub Secrets

1. **GITHUB_TOKEN** - Автоматически предоставляется

## Локальная автоматизация

### Скрипт автоматизированного тестирования

```bash
# Запуск всех тестов с очисткой кэша
./Scripts/automated-testing.sh --clean --all --reports

# Запуск только Unit тестов
./Scripts/automated-testing.sh --unit

# Запуск тестов с покрытием кода
./Scripts/automated-testing.sh --coverage --reports

# Запуск с уведомлениями
./Scripts/automated-testing.sh --all --notifications
```

### Опции скрипта

- `-h, --help` - Показать справку
- `-c, --clean` - Очистить кэш перед тестированием
- `-u, --unit` - Запустить только Unit тесты
- `-i, --integration` - Запустить только интеграционные тесты
- `-co, --coverage` - Запустить тесты с покрытием кода
- `-a, --all` - Запустить все тесты (по умолчанию)
- `-r, --reports` - Генерировать отчеты
- `-n, --notifications` - Отправлять уведомления
- `-v, --verbose` - Подробный вывод

## Генерация отчетов

### Python скрипт для отчетов

```bash
# Генерация отчетов
python3 Scripts/generate-test-reports.py
```

**Выходные файлы:**
- `reports/test-report.json` - JSON отчет
- `reports/test-report.html` - HTML отчет
- `reports/test-report.md` - Markdown отчет

### Dashboard мониторинга

```bash
# Создание dashboard
python3 Scripts/create-dashboard.py
```

**Выходные файлы:**
- `dashboard/index.html` - HTML dashboard
- `dashboard/test_trends.png` - График трендов тестов
- `dashboard/quality_metrics.png` - График метрик качества
- `dashboard/performance_metrics.png` - График производительности

## Конфигурация покрытия кода

### Codecov (`codecov.yml`)

**Настройки:**
- Целевое покрытие: 80%
- Порог изменения: 5%
- Игнорирование файлов: Editor, Tests, Plugins

### SonarQube (`sonar-project.properties`)

**Настройки:**
- Анализ C# кода
- Проверка безопасности
- Анализ дублирования
- Quality Gate проверки

## Dependabot

### Автоматические обновления

**Настройки:**
- Unity Package Manager: еженедельно по понедельникам
- GitHub Actions: еженедельно по понедельникам
- Docker: еженедельно по понедельникам

**Исключения:**
- Major версии критических пакетов Unity
- Major версии DOTS пакетов

## Мониторинг и алерты

### Метрики качества

1. **Покрытие кода** - минимум 80%
2. **Успешность тестов** - 100%
3. **Время сборки** - максимум 10 минут
4. **Размер сборки** - максимум 100 МБ

### Алерты

1. **Провал тестов** - немедленное уведомление
2. **Снижение покрытия** - уведомление при снижении >5%
3. **Увеличение времени сборки** - уведомление при увеличении >20%
4. **Проблемы безопасности** - немедленное уведомление

## Интеграция с внешними сервисами

### Codecov

- Автоматическая загрузка отчетов о покрытии
- Комментирование в PR
- Badge в README

### SonarQube

- Анализ качества кода
- Quality Gate проверки
- Комментирование в PR

### GitHub

- Автоматические проверки
- Branch Protection Rules
- Required Status Checks

## Troubleshooting

### Частые проблемы

1. **Unity License ошибки**
   - Проверить правильность secrets
   - Убедиться в актуальности лицензии

2. **Ошибки сборки**
   - Проверить версии пакетов
   - Очистить кэш Unity

3. **Провал тестов**
   - Проверить логи тестов
   - Убедиться в корректности тестовых данных

4. **Проблемы с покрытием**
   - Проверить настройки Codecov
   - Убедиться в корректности путей к файлам

### Логи и отладка

1. **Логи GitHub Actions** - доступны в разделе Actions
2. **Локальные логи** - сохраняются в `artifacts/`
3. **Логи Unity** - доступны в `Editor.log`

## Best Practices

### Тестирование

1. **Покрытие кода** - минимум 80%
2. **Unit тесты** - для всех публичных методов
3. **Интеграционные тесты** - для критических путей
4. **Тесты производительности** - для оптимизации

### CI/CD

1. **Быстрая обратная связь** - тесты должны выполняться быстро
2. **Параллельное выполнение** - использование matrix стратегии
3. **Кэширование** - кэш Unity Library и пакетов
4. **Артефакты** - сохранение результатов тестов

### Качество кода

1. **Code Review** - обязательный для всех PR
2. **Автоматические проверки** - SonarQube, ESLint
3. **Документация** - обновление при изменениях
4. **Версионирование** - семантическое версионирование

## Заключение

Автоматизация тестирования и CI/CD обеспечивает:

- **Качество кода** - автоматические проверки
- **Быстрая обратная связь** - немедленные уведомления
- **Надежность** - автоматические тесты
- **Производительность** - мониторинг метрик
- **Безопасность** - проверки безопасности

Все настройки готовы к использованию и могут быть адаптированы под конкретные потребности проекта.
